<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BPUB On-Chain Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #050505;
      color: #f5f5f5;
    }
    header {
      max-width: 900px;
      margin: 0 auto 1rem;
    }
    h1 {
      margin: 0 0 0.25rem;
      font-size: 1.8rem;
    }
    p {
      margin: 0;
      opacity: 0.75;
      font-size: 0.9rem;
    }
    #grid {
      max-width: 1100px;
      margin: 1.5rem auto 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
    }
    .card {
      background: #111;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .card img {
      display: block;
      width: 100%;
      height: 220px;
      object-fit: cover;
      background: #000;
    }
    .meta {
      padding: 0.6rem 0.8rem 0.8rem;
      font-size: 0.8rem;
    }
    .filename {
      font-weight: 600;
      margin-bottom: 0.2rem;
      word-break: break-word;
    }
    .info {
      opacity: 0.8;
      margin-bottom: 0.25rem;
    }
    .txid {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.7rem;
      opacity: 0.7;
      word-break: break-all;
    }
    .pill {
      display: inline-block;
      padding: 0.12rem 0.45rem;
      border-radius: 999px;
      background: #222;
      font-size: 0.7rem;
      margin-left: 0.3rem;
    }
    .owner {
      margin-top: 0.25rem;
      font-size: 0.7rem;
      opacity: 0.8;
      word-break: break-all;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .owner-label {
      opacity: 0.6;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.65rem;
      margin-right: 0.25rem;
    }
    #status {
      max-width: 900px;
      margin: 0.5rem auto 0;
      font-size: 0.8rem;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <header>
    <h1>BPUB On-Chain Gallery</h1>
    <p>Images reconstructed from BPUB reveal transactions on Bitcoin.</p>
    <div id="status"></div>
  </header>

  <div id="grid"></div>

  <script>
    async function loadGallery() {
      const statusEl = document.getElementById('status');
      try {
        const res = await fetch('manifest.json', { cache: 'no-cache' });
        if (!res.ok) {
          statusEl.textContent = 'No manifest.json yet – waiting for indexer...';
          return;
        }

        const items = await res.json();
        if (!Array.isArray(items) || items.length === 0) {
          statusEl.textContent = 'No BPUB reveals indexed yet.';
          return;
        }

        let ownership = {};
        try {
          const ownRes = await fetch('ownership.json', { cache: 'no-cache' });
          if (ownRes.ok) {
            ownership = await ownRes.json();
          }
        } catch (e) {
          // ignore; ownership stays empty
        }

        // newest first
        items.sort((a, b) => (b.block_height || 0) - (a.block_height || 0));

        statusEl.textContent = `Showing ${items.length} item${items.length === 1 ? '' : 's'}.`;

        const grid = document.getElementById('grid');
        items.forEach(item => {
          if (!item.stored_filename) return;

          const card = document.createElement('div');
          card.className = 'card';

          const img = document.createElement('img');
          img.src = 'media/' + item.stored_filename;
          img.alt = item.filename || item.txid;

          const link = document.createElement('a');
          link.href = 'media/' + item.stored_filename;
          link.target = '_blank';
          link.appendChild(img);

          const meta = document.createElement('div');
          meta.className = 'meta';

          const name = document.createElement('div');
          name.className = 'filename';
          name.textContent = item.filename || '(unnamed)';

          const info = document.createElement('div');
          info.className = 'info';
          const size = item.size ? `${(item.size / 1024).toFixed(1)} kB` : 'unknown size';
          const mime = item.mime || 'application/octet-stream';
          const height = item.block_height != null ? `block ${item.block_height}` : 'unknown block';
          info.textContent = `${size} · ${mime} · ${height}`;

          const tx = document.createElement('div');
          tx.className = 'txid';
          tx.textContent = item.txid;

          meta.appendChild(name);
          meta.appendChild(info);
          meta.appendChild(tx);

          if (item.bpub_id && ownership && ownership[item.bpub_id]) {
            const ownerRecord = ownership[item.bpub_id];
            const ownerAddr = ownerRecord.current_owner_p2wpkh || ownerRecord.current_owner_p2wsh;
            if (ownerAddr) {
              const ownerDiv = document.createElement('div');
              ownerDiv.className = 'owner';

              const label = document.createElement('span');
              label.className = 'owner-label';
              label.textContent = 'Owner';

              const addrSpan = document.createElement('span');
              addrSpan.textContent = ownerAddr;

              ownerDiv.appendChild(label);
              ownerDiv.appendChild(addrSpan);
              meta.appendChild(ownerDiv);
            }
          }

          card.appendChild(link);
          card.appendChild(meta);
          grid.appendChild(card);
        });
      } catch (err) {
        statusEl.textContent = 'Error loading gallery: ' + err;
        console.error(err);
      }
    }

    loadGallery();
  </script>
</body>
</html>
