# BPUB Specification (v5)

This document defines the BPUB v5 data format and the on-chain structures used
to embed and reveal data via Bitcoin transactions.

---

## Overview

BPUB embeds arbitrary data into Bitcoin by encoding it into **fake pubkeys**.
Each fake pubkey is a valid compressed secp256k1 public key generated by
grinding a 1-byte nonce until the x-coordinate lies on the curve.

These pubkeys are placed inside a **1-of-N multisig P2WSH script**:

```
OP_1
<data_pk_0>
...
<data_pk_M>
<control_pubkey>
OP_(M+1)
OP_CHECKMULTISIG
```

Version 5 introduces **mandatory ownership**, using a separate P2WSH output:
```
<BPUB_ID>
OP_DROP
OP_DUP
OP_HASH160
<owner_h160>
OP_EQUALVERIFY
OP_CHECKSIG
```

## BPUB v5 Stream Format

The BPUB v5 stream encodes metadata and content, optionally using raw DEFLATE +
XOR obfuscation.
```
[0:4]   stream_len (uint32, BE)
[4]     version = 5
[5]     flags
[6:14]  size_uncompressed (uint64, BE)
[14:46] sha256(uncompressed) (32 bytes)
[46:48] meta_len (uint16, BE)
[48:??] meta_blob_enc (XOR(raw_deflate(JSON)), optional)
[..]    content_enc (XOR(deflated data) or XOR(raw data))
```

### Flags

| Bit | Meaning                          |
|-----|----------------------------------|
| 0   | Content is raw-deflate-compressed before XOR |
| 1   | Metadata is present              |

---

## Metadata Format (JSON)

If metadata exists, it's encoded as raw-deflate(JSON) and XOR-obfuscated.

Example metadata:

```json
{
  "mime": "image/jpeg",
  "filename": "cat.jpg",
  "bpub_id": "c2b7...9af3"
}
```

## BPUB_ID
```
bpub_id = sha256("BPUB5" || sha256(data) || size_be_8)
```

This value identifies the inscription and is committed to in the ownership
redeem script.

## Ownership Redeem Script

The owner output commits to the BPUB_ID and behaves like a P2WPKH script,
but wrapped in P2WSH:
```
<BPUB_ID>
OP_DROP
OP_DUP
OP_HASH160
<owner_h160>
OP_EQUALVERIFY
OP_CHECKSIG
```

This ensures that ownership of the BPUB can be transferred without revealing
the data.

## Reveal Transaction
To reveal the data, each multisig output must be spent. The script is recovered
from the witness, data pubkeys are extracted, decoded, and reassembled into the
BPUB stream. Once reconstructed, the original file can be recovered.

## Legacy Versions
* v3.5: TLV header with "BPUB" magic and cleartext metadata.

* v4: Same binary layout as v5, but no ownership.

* v5: (current) â€” Adds bpub_id, ownership, and optional metadata fields.